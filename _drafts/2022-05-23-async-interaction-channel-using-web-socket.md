---
title: "ASP.NET 웹에서 오래 걸리는 요청 진행 상황 보여주기"
summary: "웹소켓을 사용하여 요청 처리 상태를 실시간으로 클라이언트에게 알려줍니다."
date: 2022-05-23 21:27:18 +0900
categories:
   - dev
---

## 들어가며

하나의 HTTP 요청은 빠른 시간 안에 끝나는 것이 좋습니다. 그렇지 않으면 사용자는 오래도록 응답이 없는 페이지를 바라보면서 답답함을 느끼게 될 것입니다. 따라서 [클라이언트가 오래 걸리는 작업을 요청하면 즉시 응답을 내려준 다음에 클라이언트가 진행 상황을 물을 때마다 답변해주는 것이 좋습니다.](https://medium.com/geekculture/rest-api-best-practices-decouple-long-running-tasks-from-http-request-processing-9fab2921ace8)

그러나 현실이 녹록치 않을 때도 있습니다. 지금 작업중인 레거시 시스템은 소요 시간에 관계 없이 모든 작업을 하나의 요청-응답으로 처리합니다. 따라서 이러한 컨벤션을 모두 바꾸기는 어려운 상황이었습니다. 그래서 조금 다른 방향으로 생각해보았습니다.

## 상호작용 채널

기본적인 아이디어는, 오래 걸리는 HTTP 요청 옆에 따라가는 웹 소켓 연결을 수립하여 서버쪽 메시지 출력을 클라이언트쪽 콘솔에서 보이도록 하는 것입니다.

요청 처리 상태를 실시간으로 응답에 내려주고 싶지만, 그러려면 완성된 처리 결과를 내려주기 전에 먼저 응답이 전송되어야 합니다. 그리고 처리가 끝나면 결과를 또 다시 응답으로 보내주어야 하죠. 그러나 하나의 요청에 여러 번의 응답을 내려주는 것은 HTTP 특성상 어렵습니다.

결국 하나의 요청만 가지고는 작업 진행 상황과 작업 결과를 모두 전달할 수 없습니다. 그래서 본 요청에 바인드된 별도의 웹 소켓 연결을 사용하여 작업 진행 상황을 전달하기로 하였습니다. 이 웹 소켓 연결을 상호작용 채널(interaction channel)이라고 부르기로 하였습니다.

상호작용 채널은 웹 소켓 기반인 만큼, 요청을 처리하면서 사용자의 의사 확인이 필요할 때에 실시간으로 양방향으로 소통하며 다음 행동에 필요한 정보를 물어볼 수 있습니다. 예를 들어, 대용량의 엑셀 파일 업로드 및 DB 저장 작업을 수행하던 중에 하나의 row에서 처리 문제가 발생한 경우, 이를 무시하고 넘어갈지 아니면 전체 작업을 중단하고 되돌릴지 사용자에게 즉시 물어보고 답변에 따라 처리를 달리할 수 있습니다.

## 작동 원리

### 연결중인 상호작용 채널을 담아둡니다.

### 본 요청과 상호작용 채널을 묶습니다.

### 현재 묶인 상호작용 채널을 통해 작업 진행 상황을 보냅니다.

## References

- [REST API Best Practices — Decouple Long-running Tasks from HTTP Request Processing](https://medium.com/geekculture/rest-api-best-practices-decouple-long-running-tasks-from-http-request-processing-9fab2921ace8)
